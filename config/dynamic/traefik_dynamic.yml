# config/dynamic/traefik_dynamic.yml  (DYNAMIC CONFIG)
http:
  middlewares:
    # â†—ï¸ HTTP to HTTPS redirect
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # ğŸ” Single-Sign-On (Authentik)
    sso:
      forwardAuth:
        address: http://authentik_server:9000/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true

    # ğŸ›¡ï¸ CrowdSec placeholder (plugin disabled until download issues resolved)
    # crowdsec:
    #   plugin:
    #     bouncer:
    #       enabled: true
    #       logLevel: INFO
    #       crowdsecMode: alone

    # ğŸ§¿ Restrict to Tailscale VPN subnet for admin-only routes
    admin-vpn:
      ipAllowList:
        sourceRange:
          - 100.64.0.0/10   # Tailscale CGNAT range (primary VPN access)
          - 127.0.0.1/32    # Localhost for health checks
          - 172.18.0.0/16   # Docker proxy network (for internal container access)

    # ğŸ” Security headers
    secure-headers:
      headers:
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        frameDeny: true
        contentTypeNosniff: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "camera=(), microphone=(), geolocation=()"
        browserXssFilter: true
        customResponseHeaders:
          X-Cross-Origin-Embedder-Policy: "require-corp"
          X-Cross-Origin-Opener-Policy: "same-origin"

    # ğŸ” Security headers for Keycloak (minimal - let Keycloak control X-Frame-Options)
    keycloak-headers:
      headers:
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        # Do NOT set frameDeny or customFrameOptionsValue - let Keycloak control this header
        contentTypeNosniff: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "camera=(), microphone=(), geolocation=()"
        browserXssFilter: true

    # ğŸ›¡ï¸ CrowdSec ForwardAuth middleware
    crowdsec-fa:
      forwardAuth:
        address: http://crowdsec_bouncer:8080/api/v1/forwardAuth
        trustForwardHeader: true

    # ğŸ¨ SecureNexus Content Security Policy
    sn-csp:
      headers:
        contentSecurityPolicy: >
          default-src 'self';
          img-src 'self' data: https://brand.${DOMAIN};
          style-src 'self' https://brand.${DOMAIN};
          script-src 'self';
          connect-src 'self';
          font-src 'self' https://brand.${DOMAIN};

    # ğŸ¨ CSS Injection Middleware (disabled - plugin download issues)
    # sn-css-inject:
    #   plugin:
    #     rewritebody:
    #       rewrites:
    #         - regex: '</head>'
    #           replacement: '<link rel="stylesheet" href="https://brand.${DOMAIN}/sn.css"></head>'
    #       lastModified: true
    #       ignoredContentTypes:
    #         - application/json
    #         - application/javascript
    #         - image/svg+xml
    #         - image/png

    # ğŸ“¦ Cache middleware (disabled - plugin download issues)
    # cache:
    #   plugin:
    #     souin:
    #       configuration: /etc/traefik/dynamic/souin.yml

    # ğŸ”— SecureNexus middleware chain (CSS injection disabled)
    sn-chain:
      chain:
        middlewares:
          - sn-csp

  routers:
    # Optional catch-all HSTS/router - attaches headers globally
    # (You can enable this if you want every HTTPS route to get secure headers automatically)
    # default-secure:
    #   rule: "HostRegexp(`{any:.+}`)"
    #   entryPoints: [websecure]
    #   service: noop@internal
    #   middlewares: [secure-headers]

tcp:
  middlewares:
    # ğŸ” Lock down SMTP submission to Tailscale VPN clients
    submission-vpn:
      ipAllowList:
        sourceRange:
          - 100.64.0.0/10   # Tailscale VPN range