# SecureNexus Full Stack - Caddy Configuration
# Migrated from Traefik for enhanced Docker security (eliminates socket access)

{
    email {$EMAIL}
    admin off

    # Global CrowdSec configuration
    crowdsec {
        api_url http://crowdsec:8080
        api_key {$CROWDSEC_BOUNCER_API_KEY}
    }

    # Make sure the CrowdSec bouncer runs early in the handler chain
    order crowdsec before respond

    servers {
        protocols h1 h2 h3
    }
}

# ======================================================================
# SNIPPETS (ALL LOCAL, NO EXTERNAL IMPORTS)
# ======================================================================

# CrowdSec bouncer config (uses global configuration)
(crowdsec_config) {
    crowdsec
}

# Generic security headers for "normal" sites
(security_headers) {
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
    }
}

# Stricter headers for admin-type services
(admin_security_headers) {
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
        Cache-Control "no-store, no-cache, must-revalidate, private"
        Pragma "no-cache"
        Expires "0"
    }
}

# Placeholder for SSO auth (does nothing *yet*, just avoids parse errors)
# You can later replace this with a real Authentik/Caddy-security setup.
(sso_auth) {
    # SSO placeholder - no-op for now
}

# ======================================================================
# CORE INFRASTRUCTURE SERVICES
# ======================================================================

# Mailcow webmail and admin interface
mail.{$DOMAIN}, autodiscover.{$DOMAIN}, autoconfig.{$DOMAIN} {
    reverse_proxy mailcowdockerized-nginx-mailcow-1:8880

    # Webmail-compatible security headers (less restrictive than default)
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self';"
        X-Robots-Tag "noindex, nofollow"
    }
}

# Main landing page
{$DOMAIN} {
    reverse_proxy landing:80

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self'; img-src 'self' data: https://brand.{$DOMAIN}; style-src 'self' https://brand.{$DOMAIN}; script-src 'self'; connect-src 'self'; font-src 'self' https://brand.{$DOMAIN};"
    }

    # Handle .well-known (except ACME)
    route /.well-known/* {
        uri strip_prefix /.well-known
        reverse_proxy wellknown:80
    }

    # Internal metrics endpoint
    metrics /internal/metrics {
        disable_openmetrics
    }
}

# Authentik SSO (Multiple domains) with CrowdSec protection
authentik.{$DOMAIN}, sso.{$DOMAIN}, auth.{$DOMAIN}, auth.byrne-accounts.org {
    import crowdsec_config
    reverse_proxy authentik_server:9000

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
    }
}

# Portal/Dashboard
portal.{$DOMAIN} {
    import crowdsec_config
    import sso_auth
    reverse_proxy dashy:8080
    import security_headers
}

# Brand static assets
brand.{$DOMAIN} {
    reverse_proxy brand-static:80
    import security_headers
}

# Dashy Dashboard with CrowdSec
dashboard.{$DOMAIN}, dash.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy dashy:8080
    import security_headers
}

# ======================================================================
# ADMIN SERVICES (VPN-Only Access)
# ======================================================================

grafana.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy grafana:3000
        import admin_security_headers
    }
}

prometheus.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy prometheus:9090
        import admin_security_headers
    }
}

portainer.{$DOMAIN} {
    import sso_auth
    reverse_proxy portainer:9000
    import admin_security_headers
}

certs.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403

        route /certificates* {
            reverse_proxy cert-manager:8080
        }

        route /health* {
            reverse_proxy cert-manager:8080
        }

        route /metrics* {
            reverse_proxy cert-manager:8080
        }

        import admin_security_headers
    }
}

updates.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy watchtower:8080
        import admin_security_headers
    }
}

dns.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy coredns:8080
        import admin_security_headers
    }
}

# ======================================================================
# MONITORING & STATUS SERVICES
# ======================================================================

status.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy uptime-kuma:3001
    import security_headers
}

alerts.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy alertmanager:9093
        import admin_security_headers
    }
}

# ======================================================================
# CLOUD SERVICES
# ======================================================================

# Vikunja - Task Management
vikunja.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy vikunja:3456
    import security_headers
}

# HedgeDoc - Collaborative Markdown Editor
hedgedoc.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy hedgedoc:3000
    import security_headers
}

# Forgejo - Git Forge
git.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy forgejo:3000
    import security_headers
}

# Firefly III - Personal Finance Manager
finance.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy firefly:8080
    import security_headers
}

# Calibre - E-book Management
calibre.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy calibre:8080
    import security_headers
}

# Bitwarden/Vaultwarden - Password Manager
passwords.{$DOMAIN} {
    import crowdsec_config
    reverse_proxy bitwarden:80
    import security_headers
}

# ======================================================================
# CLIENT SERVICES (Multi-tenant ERP)
# ======================================================================

erp.byrne-accounts.org {
    @not_client_vpn not remote_ip 100.64.0.0/20 100.100.0.0/18 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_client_vpn "Access denied - Client VPN required" 403

        route /socket.io/* {
            reverse_proxy erpnext-backend:8000
        }

        reverse_proxy erpnext-backend:8000
        import security_headers
    }
}

pos.byrne-accounts.org {
    @not_client_vpn not remote_ip 100.64.0.0/20 100.100.0.0/18 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_client_vpn "Access denied - Client VPN required" 403
        reverse_proxy erpnext-backend:8000
        import security_headers
    }
}

portal.byrne-accounts.org {
    import sso_auth
    reverse_proxy byrne-website:80
    import security_headers
}

byrne-accounts.org, www.byrne-accounts.org {
    reverse_proxy byrne-website:80
    import security_headers
}

setup.byrne-accounts.org {
    reverse_proxy erpnext-backend:8080
    import security_headers
}

erp.dickson-supplies.com {
    encode zstd gzip

    # SSO temporarily disabled - native login working
    # redir https://auth.securenexus.net/outpost.goauthentik.io/start?rd=https%3A//erp.dickson-supplies.com{uri}

    # ERPNext backend with proper headers for SSO
    reverse_proxy dickson-backend:8000 {
        # IMPORTANT: tell upstream it's HTTPS + correct host for ERPNext SSO
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up Host {host}

        transport http {
            read_buffer 8192
            write_buffer 8192
        }
    }

    import security_headers
}

pos.dickson-supplies.com {
    encode zstd gzip

    # SSO temporarily disabled - native login working
    # redir https://auth.securenexus.net/outpost.goauthentik.io/start?rd=https%3A//pos.dickson-supplies.com{uri}

    # Rewrite root to POS interface path
    @root path /
    rewrite @root /app/point-of-sale

    # Route to ERPNext POS interface with proper headers for SSO
    reverse_proxy dickson-backend:8000 {
        # IMPORTANT: Use the ERPNext site's configured host for proper routing
        header_up Host erp.dickson-supplies.com
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host pos.dickson-supplies.com
    }

    import security_headers
}

# ======================================================================
# NOTESNOOK SYNC SERVER
# ======================================================================

identity.{$DOMAIN} {
    reverse_proxy notesnook-identity:8264
    import security_headers
}

notes.{$DOMAIN} {
    reverse_proxy notesnook-server:5264
    import security_headers
}

events.{$DOMAIN} {
    reverse_proxy notesnook-sse:7264
    import security_headers
}

mono.{$DOMAIN} {
    reverse_proxy notesnook-monograph:3000
    import security_headers
}

files.{$DOMAIN} {
    reverse_proxy notesnook-s3:9000
    import security_headers
}

# ======================================================================
# ADDITIONAL SERVICES
# ======================================================================

apps.{$DOMAIN} {
    import sso_auth
    reverse_proxy apps-catalog:3000
    import security_headers
}

docs.{$DOMAIN} {
    import sso_auth
    reverse_proxy docs:3000
    import security_headers
}

nextcloud.{$DOMAIN} {
    import sso_auth
    reverse_proxy nextcloud:80

    header {
        Strict-Transport-Security "max-age=155520011; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Forwarded-Proto "https"
        +X-Forwarded-For "{remote}"
    }
}

keycloak.{$DOMAIN} {
    reverse_proxy keycloak:8080

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
    }
}

kanidm.{$DOMAIN} {
    reverse_proxy kanidm:8443 {
        transport http {
            tls_insecure_skip_verify
        }
    }
    import security_headers
}

etcd-ui.{$DOMAIN} {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - VPN required" 403
        reverse_proxy etcd-ui:8080
        import admin_security_headers
    }
}

# ======================================================================
# EVIL RABBIT ART - CLIENT WEBSITE
# Gothic Artist Portfolio & Ecommerce Platform
# "Art from the Strange Burrow"
# ======================================================================

# Main Evil Rabbit Art website - Public with CrowdSec protection
evilrabbitart.com, www.evilrabbitart.com {
    import crowdsec_config
    reverse_proxy evilrabbit-wordpress:80

    # Ecommerce-optimized security headers
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-XSS-Protection "1; mode=block"
        X-WC-Store-API "evilrabbitart"
    }

    # Static assets caching
    @static_assets {
        path *.css *.js *.jpg *.jpeg *.png *.webp *.svg *.woff *.woff2
    }
    header @static_assets {
        Cache-Control "public, max-age=3600"
    }

    # Performance optimization for artwork images
    @artwork_images {
        path *.jpg *.jpeg *.png *.webp *.svg /wp-content/uploads/*
    }
    header @artwork_images {
        Cache-Control "public, max-age=31536000, immutable"
        Vary "Accept-Encoding"
    }

    # WooCommerce API endpoints
    @wc_api {
        path /wp-json/wc/*
        path /wc-api/*
        path /cart/*
        path /checkout/*
        path /my-account/*
    }
    header @wc_api {
        Cache-Control "no-cache, no-store, must-revalidate"
    }

    # WordPress admin protection (Cloud Architects only)
    @wp_admin {
        path /wp-admin/*
        path /wp-login.php
    }
    respond @wp_admin "WordPress admin access restricted to authorized personnel only. Contact Cloud Architects for support." 403
}

# Artist Management Portal - SSO Protected
manage.evilrabbitart.com {
    import sso_auth
    reverse_proxy evilrabbit-wordpress:80

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-Portal-Type "artist-management"
        X-Powered-By "Cloud Architects - SecureNexus"
    }

    redir / /wp-admin/
}

# Admin Access - VPN Only (Cloud Architects Control)
admin.evilrabbitart.com {
    @not_vpn not remote_ip 100.64.0.0/16 100.100.0.0/16 100.101.0.0/16 127.0.0.1/32 172.18.0.0/16

    route {
        respond @not_vpn "Access denied - Cloud Architects VPN required" 403

        reverse_proxy evilrabbit-wordpress:80
        import admin_security_headers

        header {
            X-Admin-Portal "cloud-architects"
            X-Client-Site "evilrabbitart"
        }
    }
}
