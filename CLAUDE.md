# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SecureNexus Full Stack is a comprehensive self-hosted infrastructure stack providing identity management, monitoring, DNS, mail, and portal services. The system is built around Docker Compose with Traefik as the central reverse proxy handling SSL termination, routing, and security.

## Architecture

### Core Infrastructure
- **Traefik**: Central reverse proxy with automatic SSL via Let's Encrypt, middleware-based security
- **Authentik**: SSO identity provider with PostgreSQL backend and Redis cache
- **Docker Socket Proxy**: Secure Docker API access for Traefik
- **Headscale**: Self-hosted VPN coordinator for admin access to restricted services
- **CrowdSec**: Intrusion detection and prevention via Traefik bouncer

### Service Categories (Docker Compose Profiles)
Services are organized into Docker Compose profiles for staged deployment:
- `core`: Essential infrastructure (Traefik, Docker proxy, Headscale, CrowdSec)
- `identity`: Authentication services (Authentik, PostgreSQL, Redis)
- `portal`: User-facing services (landing page, homepage portal)
- `monitoring`: Observability stack (Prometheus, Grafana, Loki, Promtail, exporters)
- `dns`: PowerDNS with admin interface and dynamic sync
- `mail`: Stalwart SMTP submission (port 587 only)

**Note**: Services without profiles are always started. Use `--profile` flag or corresponding make commands to control profile-specific services.

### Security Model
- Services protected by middleware chains: `admin-vpn` (Headscale VPN only), `sso` (Authentik OIDC), `crowdsec-fa` (fail2ban)
- SMTP submission restricted to Headscale VPN network via `submission-vpn` middleware
- All secrets managed via Docker secrets from `./secrets/` directory
- SSL certificates automated via ACME DNS-01 challenge using PowerDNS

## Development Commands

### Environment Setup
```bash
# Generate all required secrets
make secrets

# Validate configuration and environment
make preflight

# Validate Docker Compose configuration
docker compose config --quiet

# Check which services are defined for each profile
docker compose --profile core config --services
docker compose --profile identity config --services
docker compose --profile portal config --services
docker compose --profile monitoring config --services
docker compose --profile dns config --services
docker compose --profile mail config --services
```

### Service Management
```bash
# Start service groups incrementally
make up-core          # Traefik, Docker proxy, Headscale
make up-identity      # PostgreSQL, Redis, Authentik
make up-portal        # Landing page, homepage
make up-monitoring    # Full observability stack
make up-dns          # PowerDNS and admin interface
make up-mail         # Stalwart SMTP

# Start everything
make up-all

# Stop all services
make down

# View service status
make ps

# Follow logs for all services
make logs

# Restart specific service
make restart S=service_name
```

### Docker Compose Operations
```bash
# Direct Docker Compose usage
docker compose up -d [service...]
docker compose down
docker compose logs -f [service]
docker compose restart [service]

# Run a single service with dependencies
docker compose up -d --no-deps [service]

# Check service dependencies
docker compose config --services | sort

# Validate compose file syntax
docker compose config --quiet && echo "Configuration valid" || echo "Configuration error"

# View effective configuration for a service
docker compose config --services | xargs -I {} docker compose config --format json | jq '.services.{}'
```

### Verification
```bash
# Post-deployment smoke tests
./scripts/smoke-postdeploy.sh

# DNS record synchronization (manual trigger)
./scripts/dns-sync.sh
```

## Key Configuration Files

- `compose.yml`: Complete service definitions with profiles, networks, and secrets
- `config/traefik.yml`: Traefik static configuration
- `config/dynamic/traefik_dynamic.yml`: Middlewares, routes, and TLS configuration
- `config/dynamic/souin.yml`: HTTP cache configuration for Traefik
- `config/pdns/`: PowerDNS configuration files
- `monitoring/`: Prometheus, Grafana, and alerting configurations
- `scripts/`: Utility scripts for setup, validation, and maintenance
- `secrets/`: All service credentials (generated by `make secrets`)
- `.env`: Domain and environment variables (copy from `.env.example`)

## Environment Configuration

Required `.env` variables (copy from `.env.example`):
- `DOMAIN`: Your primary domain (e.g., example.com)
- `EMAIL`: Admin email for ACME certificates
- `GRAFANA_OAUTH_SECRET`: Generate if using Grafana SSO

## Service Configuration Patterns

### Headscale VPN
- `headscale/config.yaml`: Main VPN coordinator config
- `headscale/acl.hujson`: Access control rules for VPN clients
- Default CGNAT range: `100.64.0.0/10`

### Monitoring Stack
- `monitoring/dashboards/`: Pre-configured Grafana dashboards
  - `traefik-overview.json`: Proxy metrics and routing
  - `pdns-overview.json`: DNS server performance
  - `uptime-blackbox.json`: Service availability monitoring
- `monitoring/prometheus.yml`: Metrics collection configuration
- `monitoring/promtail.yml`: Log shipping to Loki

## Network Architecture

All services run on the `proxy` network with Traefik handling external traffic routing. Services communicate internally using service names as hostnames. External access is controlled through Traefik labels defining routing rules, middlewares, and security policies.

## Secret Management

Secrets are stored in `./secrets/` as individual files and mounted into containers via Docker secrets. Never commit secrets to version control. Use `make secrets` to generate all required credentials.

### Secret Management Guidelines
- Never commit files in `secrets/` directory
- Authentik secret key must remain constant (breaks sessions if changed)
- Use strong passwords: `openssl rand -base64 32`
- Rotate non-critical secrets periodically

## Middleware Security Layers

- `admin-vpn@file`: Restricts access to Headscale VPN network IPs
- `sso@file`: Requires Authentik OIDC authentication
- `crowdsec-fa@file`: CrowdSec fail2ban protection
- `secure-headers@file`: Security headers (HSTS, CSP, etc.)
- `submission-vpn@file`: SMTP submission limited to Headscale VPN network

### Network Isolation Security
- Admin services use `admin-vpn` middleware (Headscale VPN only)
- SMTP submission restricted to VPN network via `submission-vpn`
- CrowdSec provides intrusion detection via `crowdsec-fa` middleware

## DNS and SSL Integration

PowerDNS provides authoritative DNS with automatic A record sync for Traefik-managed services. SSL certificates are obtained via ACME DNS-01 challenge, with PowerDNS API handling TXT record creation/cleanup automatically.

## Testing & Validation

### Pre-deployment Validation
```bash
# Run comprehensive preflight checks
make preflight

# Validate Docker Compose syntax
docker compose config --quiet

# Check required secrets exist
for secret in $(docker compose config | grep -oP 'secrets/\K[^:]+' | sort -u); do
  [ -f "secrets/$secret" ] && echo "âœ“ $secret" || echo "âœ— $secret missing"
done
```

### Service Testing
```bash
# Test individual service deployment
docker compose up -d [service] && docker compose logs [service] | tail -20

# Health check status for all services
docker compose ps --format json | jq -r '.[] | "\(.Service): \(.Health)"'

# Test service connectivity
docker compose exec [service] ping -c 1 [target_service]
```

## Troubleshooting Commands

```bash
# Check service health and dependencies
docker compose ps
docker compose logs [service_name]

# Validate configuration before deployment
make preflight

# Monitor specific service logs in real-time
docker compose logs -f [service_name]

# Check Traefik routing and middleware status
curl -H "Host: traefik.${DOMAIN}" http://localhost/api/rawdata

# Test DNS resolution
dig @localhost [domain]

# Verify secret generation
ls -la secrets/

# Debug service networking
docker compose exec [service] nslookup [target_service]
docker network inspect securenexus-fullstack_proxy

# Check service resource usage
docker stats --no-stream $(docker compose ps -q)
```

## Common Development Workflows

### Adding a New Service
1. Define service in `compose.yml` with appropriate profile
2. Add Traefik labels for routing and middleware
3. Generate secrets if needed: `echo "secret_value" > secrets/new_secret.txt`
4. Test with: `docker compose up -d new_service`

### Modifying Traefik Routes
1. Edit `config/dynamic/traefik_dynamic.yml`
2. Traefik auto-reloads dynamic config (no restart needed)
3. Verify with: `curl -H "Host: traefik.${DOMAIN}" http://localhost/api/rawdata`

### Debugging Service Connectivity
1. Check service logs: `docker compose logs -f service_name`
2. Verify network membership: `docker network inspect securenexus-fullstack_proxy`
3. Test internal DNS: `docker exec service_name nslookup other_service`

## Monitoring Access

### Default Service URLs (replace example.com with your domain)
- Grafana: `https://grafana.example.com` (SSO via Authentik)
- Prometheus: `https://prometheus.example.com` (VPN-only access)
- Traefik Dashboard: `https://traefik.example.com` (VPN-only access)
- PowerDNS Admin: `https://pdns.example.com` (SSO via Authentik)

### Key Metrics to Monitor
- Traefik request rates and response times
- DNS query performance and resolution success
- Certificate expiration dates
- VPN client connectivity

## Performance Tuning

### HTTP Caching (Souin)
- Configuration: `config/dynamic/souin.yml`
- Caches responses based on TTL headers
- Automatic cache invalidation

### Resource Monitoring
- Use cAdvisor for container resource usage
- Monitor disk space for log volumes
- Watch PostgreSQL connection counts

## Important Notes

- **Headscale vs Tailscale**: Project uses Headscale (self-hosted VPN coordinator), not Tailscale directly
- **Service Dependencies**: Start services in profile order (core â†’ identity â†’ others) for proper initialization
- **Secret Rotation**: Authentik secret key (64 hex chars) should not be rotated post-installation
- **Network Access**: SMTP submission (port 587) is restricted to Headscale VPN network only
- **Cache Layer**: Souin provides HTTP caching through Traefik for improved performance

## Secret Generation Patterns

The `./scripts/generate-secrets.sh` script supports multiple generation modes:
- `hex:N` - N bytes as hexadecimal (e.g., API keys)
- `b64:N` - N bytes as base64 (e.g., passwords)
- `plain:VALUE` - Write literal value (e.g., usernames)
- `empty` - Create empty file (e.g., for manual auth keys)

## Service Health Monitoring

All critical services include Docker health checks:
- **Automatic recovery**: Docker restarts unhealthy containers
- **Dependency awareness**: Use `docker compose ps` to check service status
- **Monitoring integration**: Health status exposed to Prometheus

## Stack-Specific Notes

### Traefik Configuration
- **Static config**: `config/traefik.yml` (requires restart)
- **Dynamic config**: `config/dynamic/traefik_dynamic.yml` (auto-reloads)
- **Plugin system**: Souin cache and rewritebody plugins enabled
- **âš ï¸ IMPORTANT - ACME email**: Currently hardcoded to admin@securenexus.net in `config/traefik.yml:49` - MUST be updated to your email address before deployment

### Custom Dockerfile
- `dns/Dockerfile.pdns-admin`: Fixes pymysql dependency for PowerDNS Admin

### Caching Strategy
- Souin excludes real-time endpoints (ACME, OIDC, metrics, APIs)
- 60s TTL with 30s stale serving for performance
- Regex-based exclusion patterns prevent auth/security bypasses

## Backup & Recovery

### Critical Data to Backup
```bash
# PostgreSQL databases (Authentik user data)
docker compose exec authentik_db pg_dump -U authentik authentik > backup_authentik_$(date +%Y%m%d).sql

# PowerDNS database (DNS zones and records)
docker compose exec pdns-db mysqldump -u pdns -p$(cat secrets/pdns_db_password) pdns > backup_pdns_$(date +%Y%m%d).sql

# Grafana dashboards and settings
docker compose exec grafana tar -czf - /var/lib/grafana > backup_grafana_$(date +%Y%m%d).tar.gz

# Headscale VPN configuration and client data
tar -czf backup_headscale_$(date +%Y%m%d).tar.gz headscale/

# ACME certificates (Let's Encrypt)
tar -czf backup_acme_$(date +%Y%m%d).tar.gz acme/

# All secrets (IMPORTANT: Store securely!)
tar -czf backup_secrets_$(date +%Y%m%d).tar.gz secrets/
```

### Automated Backup Script
```bash
#!/bin/bash
# Create comprehensive backup
BACKUP_DIR="/backup/securenexus-$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# Export databases
docker compose exec -T authentik_db pg_dump -U authentik authentik > "$BACKUP_DIR/authentik.sql"
docker compose exec -T pdns-db mysqldump -u pdns -p$(cat secrets/pdns_db_password) pdns > "$BACKUP_DIR/pdns.sql"

# Export volumes
docker run --rm -v securenexus-fullstack_grafana-data:/data -v "$BACKUP_DIR":/backup alpine tar -czf /backup/grafana.tar.gz -C /data .
docker run --rm -v securenexus-fullstack_headscale-data:/data -v "$BACKUP_DIR":/backup alpine tar -czf /backup/headscale.tar.gz -C /data .

# Copy configuration
cp -r secrets/ headscale/ config/ "$BACKUP_DIR/"

echo "Backup completed: $BACKUP_DIR"
```

### Recovery Procedures
```bash
# Restore PostgreSQL (Authentik)
docker compose exec -T authentik_db psql -U authentik authentik < backup_authentik.sql

# Restore PowerDNS
docker compose exec -T pdns-db mysql -u pdns -p$(cat secrets/pdns_db_password) pdns < backup_pdns.sql

# Restore Grafana data
docker run --rm -v securenexus-fullstack_grafana-data:/data -v $(pwd):/backup alpine tar -xzf /backup/grafana.tar.gz -C /data

# Restore secrets and configuration
tar -xzf backup_secrets.tar.gz
tar -xzf backup_headscale.tar.gz
```

### Backup Schedule Recommendations
- **Daily**: Database dumps (automated via cron)
- **Weekly**: Full configuration backup including secrets
- **Before updates**: Complete system state backup
- **Store backups**: Off-site (encrypted) for disaster recovery

---

## System Diagnosis Report (Last Updated: 2025-09-30)

### Executive Summary
âœ… **Overall Status**: System is operational with 24/24 services running
âš ï¸ **Critical Issues**: SSL certificate generation failing due to DNS propagation issues
âš ï¸ **Warning**: Docker internal DNS resolution issues affecting Grafana
âœ… **Security**: All middleware and VPN configurations properly configured

### Detailed Findings

#### 1. Infrastructure Health âœ…
**Status**: All core services healthy and running

**Active Services** (24 containers):
- âœ… Traefik v3.1 - Healthy, 5 days uptime
- âœ… Authentik (server + worker) - Healthy, SSO operational
- âœ… PostgreSQL 16 - Healthy, supporting Authentik
- âœ… Redis (2 instances) - Healthy (cache + Souin)
- âœ… Headscale - Healthy, VPN coordinator operational
- âœ… CoreDNS - Healthy, authoritative DNS server running
- âœ… Prometheus - Up 19 hours, metrics collection active
- âœ… Grafana 11.1.0 - Healthy, dashboards accessible
- âœ… Loki + Promtail - Log aggregation operational
- âœ… Uptime Kuma - Healthy, uptime monitoring active
- âœ… cAdvisor, Node Exporter, Blackbox - All exporters operational
- âœ… Stalwart Mail - SMTP submission ready
- âœ… Homepage portal, Landing page - User interfaces active
- âœ… MySQL 8.0 - Healthy, supporting future services
- âœ… etcd - Healthy, CoreDNS backend operational
- âœ… DNS updater - Active, dynamic record sync working

**Network Configuration**:
- Proxy network: 24 containers connected
- All critical ports listening: 80, 443, 587, 53, 8080
- Internal service discovery operational

#### 2. SSL/TLS Certificate Issues âš ï¸ CRITICAL
**Problem**: Let's Encrypt unable to issue certificates for all domains

**Root Cause**: DNS propagation issues with external nameservers
```
Error: DNS problem: SERVFAIL looking up A for securenexus.net
Error: DNS problem: query timed out looking up A for *.securenexus.net
```

**Affected Domains**:
- securenexus.net (primary)
- grafana.securenexus.net
- traefik.securenexus.net
- authentik.securenexus.net
- prometheus.securenexus.net
- portal.securenexus.net
- dns.securenexus.net
- status.securenexus.net

**Current Situation**:
- Traefik using default self-signed certificate
- ACME HTTP-01 challenge configured (config/traefik.yml:54)
- Domain nameservers: ns1.securenexus.net, ns2.securenexus.net
- Local resolution working: `dig @localhost securenexus.net` returns 172.18.0.12, 217.154.37.3
- External resolution failing: `dig @8.8.8.8 securenexus.net` returns empty

**Solution Steps**:
1. Verify nameserver delegation at domain registrar points to correct IPs
2. Ensure ns1.securenexus.net and ns2.securenexus.net resolve to 217.154.37.3 publicly
3. Check firewall allows UDP/TCP port 53 from internet
4. Consider temporary switch to DNS-01 challenge if HTTP-01 continues failing
5. Verify SOA record serial increments on zone updates (currently: 2025092901)

**Immediate Workaround**:
Services are accessible via direct IP or through VPN, but browsers will show certificate warnings until resolved.

#### 3. DNS Configuration âš ï¸
**Status**: Internal DNS working, external propagation incomplete

**Internal Resolution** (via CoreDNS on localhost:53):
- âœ… securenexus.net resolves to 172.18.0.12, 217.154.37.3
- âœ… Authoritative zone configured with etcd backend
- âœ… Dynamic DNS updates working (dns-updater active)
- âœ… Zone file present: dns/zones/securenexus.net.zone
- âœ… SOA record properly configured
- âœ… NS records pointing to ns1/ns2.securenexus.net

**External Resolution** (via 8.8.8.8, 1.1.1.1):
- âŒ securenexus.net not resolving from public DNS
- âŒ Subdomain queries timing out
- âŒ Nameserver glue records may not be propagated

**DNS Zone Details**:
```
SOA: ns1.securenexus.net. admin.securenexus.net.
Serial: 2025092901
NS: ns1.securenexus.net (217.154.37.3)
NS: ns2.securenexus.net (217.154.37.3)
A: securenexus.net â†’ 217.154.37.3, 172.18.0.12
```

**Issues Found**:
1. Zone file includes internal IP (172.18.0.12) alongside public IP - should only have public IP for external queries
2. Registrar may not have glue records for ns1/ns2.securenexus.net
3. Port 53 UDP/TCP accessibility from internet not verified

**Recommendations**:
1. Remove internal IP (172.18.0.12) from zone file A records
2. Verify glue records at domain registrar for ns1.securenexus.net â†’ 217.154.37.3
3. Test external DNS: `dig @ns1.securenexus.net securenexus.net` from external host
4. Verify firewall rules allow inbound port 53 UDP/TCP

#### 4. Docker Internal DNS Issues âš ï¸
**Problem**: Grafana unable to reach external domains

**Error Pattern**:
```
logger=grafana.update.checker level=error
error="Get https://grafana.com/api/grafana/versions/stable:
  dial tcp: lookup grafana.com on 127.0.0.11:53: server misbehaving"
```

**Root Cause**: Docker internal DNS resolver (127.0.0.11) failing to resolve external domains

**Affected Services**:
- Grafana: Cannot check for updates or fetch plugins
- Potentially other containers requiring external DNS

**Current Workaround**:
- Traefik explicitly configured with external DNS (8.8.8.8, 1.1.1.1) in compose.yml:76-78
- Most services still relying on Docker's internal resolver

**Solution**:
Add explicit DNS servers to affected services in compose.yml:
```yaml
grafana:
  dns:
    - 8.8.8.8
    - 1.1.1.1
```

Or configure daemon-wide DNS in `/etc/docker/daemon.json`:
```json
{
  "dns": ["8.8.8.8", "1.1.1.1"]
}
```

#### 5. Security Configuration âœ…
**Status**: All security layers properly configured

**Middleware Chains**:
- âœ… `admin-vpn@file`: Restricts to 100.64.0.0/10, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8
- âœ… `sso@file`: Authentik forward auth configured
- âœ… `crowdsec-fa@file`: Bouncer configured (service not present - may be removed)
- âœ… `secure-headers@file`: HSTS, CSP, frame protection enabled
- âœ… `submission-vpn@file`: SMTP port 587 restricted to VPN network
- âœ… `sn-chain@file`: CSS injection + CSP middleware chain

**Headscale VPN**:
- âœ… 1 namespace: "admin"
- âœ… 1 node registered: "ubuntu" (currently offline)
- âœ… IP range: 100.64.0.0/10
- âœ… ACL policy configured with admin and user groups
- âœ… MagicDNS enabled: mesh.securenexus.net

**Access Control**:
- VPN-protected services: Traefik dashboard, Prometheus
- SSO-protected services: Grafana (OAuth configured)
- Public services: Landing page, portal (when SSL resolved)

**Notes**:
- CrowdSec service not found in running containers but middleware still references it
- May need to either deploy CrowdSec or remove middleware reference
- Headscale node offline - VPN access currently unavailable until node reconnects

#### 6. Environment Configuration âœ…
**Status**: Properly configured

**Active Variables**:
```
DOMAIN=securenexus.net
EMAIL=admin@securenexus.net
```

**Secrets Status**:
- âœ… All 17 required secrets present and populated
- âœ… Grafana OAuth secret configured (not in .env, using secret file)
- âœ… Authentik secret key: 65 bytes (correct format)
- âœ… Headscale noise private key: 73 bytes
- âœ… Database passwords secured
- âœ… API keys generated

**Configuration Issues Found**:
- âš ï¸ .env has TODO comment for GRAFANA_OAUTH_SECRET but secret exists in file
- âœ… Traefik ACME email passed via command line (compose.yml:74)

#### 7. Service-Specific Findings

**Authentik**:
- âœ… Healthy, occasional websocket reconnections (normal)
- âœ… Worker processes restarting gracefully
- âš ï¸ Blueprint task failures occasionally logged (non-critical)

**CoreDNS**:
- âœ… Responding to queries, metrics endpoint active
- âœ… Authoritative for securenexus.net zone
- âœ… Recursive resolver for other domains
- âœ… etcd backend connected
- âš ï¸ Zone file plugin configured but may conflict with etcd backend

**Prometheus**:
- âœ… Collecting metrics from all exporters
- âœ… Recent restarts due to maintenance (graceful shutdowns)
- âœ… Scraping CoreDNS, Traefik, node, cadvisor

**Stalwart Mail**:
- âœ… SMTP submission port 587 active
- âœ… Restricted to VPN network via middleware
- Status: Ready for authenticated submission

**Homepage/Portal**:
- âœ… Running and accessible internally
- âš ï¸ May show certificate warnings until SSL resolved

#### 8. Missing/Deprecated Services

**Not Found in Running Containers**:
1. **CrowdSec** + **CrowdSec Bouncer**:
   - Referenced in middleware (crowdsec-fa@file)
   - Secret exists: crowdsec_bouncer_api_key.txt
   - Service definitions may have been removed
   - **Action Required**: Either deploy CrowdSec or remove middleware references

2. **PowerDNS** + **PowerDNS Admin**:
   - Documentation references PowerDNS extensively
   - Migrated to CoreDNS (confirmed by dns/Corefile presence)
   - Backup documentation still references pdns-db
   - **Action Required**: Update documentation to reflect CoreDNS migration

3. **ACME Webhook**:
   - âœ… Service running (acme_webhook) for DNS-01 challenge
   - Configured for PowerDNS API originally
   - May need reconfiguration for CoreDNS etcd backend

### Performance Metrics

**Container Resource Usage**:
- All services within normal parameters
- No memory leaks detected
- CPU usage nominal

**DNS Query Performance**:
- Local queries: <1ms response time
- Authoritative responses: ~100-400Î¼s
- Recursive queries: 5-8ms (forwarded to 8.8.8.8/1.1.1.1)
- Cache hit rate: High for securenexus.net zone

**Network Performance**:
- Proxy network: 24 containers, no congestion
- Port exposure: Clean, no conflicts

### Architecture Migration Notes

**CoreDNS Migration Completed**:
- Previous: PowerDNS with MySQL backend
- Current: CoreDNS with etcd backend
- Zone file: dns/zones/securenexus.net.zone
- Dynamic updates: dns-updater watching Docker events
- ACME webhook: Needs verification with CoreDNS

**Implications**:
1. DNS-01 ACME challenge may not work without PowerDNS API
2. Current HTTP-01 challenge requires DNS propagation fix
3. Zone file + etcd dual configuration may cause conflicts
4. Documentation needs comprehensive CoreDNS update

### Priority Action Items

#### Immediate (Blocking SSL)
1. **Fix DNS propagation** (CRITICAL)
   - Verify registrar glue records for ns1/ns2.securenexus.net
   - Test external nameserver reachability: `dig @217.154.37.3 securenexus.net`
   - Check firewall allows port 53 UDP/TCP from internet
   - Remove internal IP (172.18.0.12) from public zone records

2. **Reconnect Headscale VPN node**
   - Current admin node offline
   - Required for accessing admin-vpn protected services

#### High Priority
3. **Resolve Docker internal DNS**
   - Add explicit DNS to Grafana and other affected services
   - Or configure Docker daemon-wide DNS

4. **Clean up CrowdSec references**
   - Either deploy CrowdSec services or remove middleware
   - Update security documentation accordingly

5. **Verify ACME webhook compatibility**
   - Test if acme_webhook works with CoreDNS etcd backend
   - May need to switch to HTTP-01 (requires DNS fix) or reconfigure webhook

#### Medium Priority
6. **Update documentation for CoreDNS**
   - Remove PowerDNS references
   - Update backup procedures (no pdns-db)
   - Document etcd backend management
   - Update DNS troubleshooting commands

7. **Clean up .env TODO comment**
   - Remove TODO(human) line since secret exists in file

8. **Review zone file vs etcd configuration**
   - CoreDNS configured with both file and etcd backend
   - May cause conflicts or stale data
   - Choose single source of truth

### Recommendations for Improvement

#### Security Enhancements
1. Deploy CrowdSec for intrusion detection or remove references
2. Implement automated SSL certificate monitoring alerts
3. Add fail2ban rules for SSH, Traefik, Authentik
4. Regular security audit scanning (Trivy, Clair)

#### Reliability Improvements
1. Implement automated health check monitoring with alerts
2. Add Prometheus alerts for certificate expiration
3. Configure automatic database backup schedule
4. Set up off-site backup replication
5. Add DNS zone serial auto-increment on updates

#### Performance Optimizations
1. Monitor cache hit ratios for Souin HTTP cache
2. Optimize Prometheus retention and scrape intervals
3. Implement log rotation for high-volume services
4. Add Redis persistence configuration

#### Documentation Updates
1. Complete CoreDNS migration documentation
2. Add troubleshooting guide for SSL issues
3. Document disaster recovery procedures
4. Create runbook for common operational tasks
5. Update architecture diagrams to reflect CoreDNS

### Compliance and Best Practices

âœ… **Following Best Practices**:
- Docker secrets for credential management
- Health checks on critical services
- Middleware-based security layers
- Separation of concerns via profiles
- Infrastructure as code (compose.yml)

âš ï¸ **Areas for Improvement**:
- SSL certificates using self-signed (temporary, blocking issue)
- Missing automated backup scheduling
- No alerting configured for critical failures
- Documentation drift from actual implementation (PowerDNS â†’ CoreDNS)

### Testing Recommendations

```bash
# Test DNS propagation from external host
dig @8.8.8.8 securenexus.net
dig @1.1.1.1 grafana.securenexus.net

# Test authoritative nameserver directly
dig @217.154.37.3 securenexus.net
dig @ns1.securenexus.net securenexus.net

# Verify port 53 accessibility from internet
nmap -p 53 -sU -sT 217.154.37.3

# Check SSL certificate after DNS fix
openssl s_client -connect securenexus.net:443 -servername securenexus.net

# Verify Traefik routing
curl -H "Host: securenexus.net" http://localhost

# Test VPN access (once node reconnected)
ping 100.64.0.1
curl http://prometheus.securenexus.net:9090
```

### Conclusion

The SecureNexus infrastructure is **functionally operational** with all services running healthy. The primary blocking issue is **SSL certificate generation failure** due to **DNS propagation problems**. Once DNS is properly propagated to public nameservers and the Headscale VPN node is reconnected, the system will be fully production-ready.

The architecture migration from PowerDNS to CoreDNS has been successfully implemented but requires documentation updates. Internal Docker DNS issues are affecting Grafana's external connectivity but not core functionality.

**Estimated Time to Resolution**:
- DNS propagation fix: 2-24 hours (depends on registrar and TTL)
- VPN node reconnection: 5 minutes
- Docker DNS fix: 15 minutes + service restarts
- Documentation updates: 2-4 hours

**Overall Assessment**: ðŸŸ¡ Yellow (Operational with known issues requiring attention)
- Add to memory