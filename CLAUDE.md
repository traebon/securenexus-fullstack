# CLAUDE.md

This file provides guidance to Claude Code when working with the SecureNexus Full Stack infrastructure.

## Table of Contents
- [ðŸ“Š System Status](#-system-status)
- [ðŸš€ Quick Start](#-quick-start)
- [ðŸ—ï¸ Architecture Overview](#ï¸-architecture-overview)
- [ðŸŒ Services & Access](#-services--access)
- [âš™ï¸ Configuration & Setup](#ï¸-configuration--setup)
- [ðŸ”§ Operations & Maintenance](#-operations--maintenance)
- [ðŸ’¾ Backup & Recovery](#-backup--recovery)
- [ðŸ“š Reference & Resources](#-reference--resources)

---

## ðŸ“Š System Status

**Current Status**: âœ… **OPERATIONAL EXCELLENCE** - 100% healthy with unified visual identity

### Live Metrics
- **Containers**: 81 running (53 SecureNexus + 28 Mailcow) - All healthy
- **Security**: A+ grade (CrowdSec + Caddy security + 100+ IPs blocked)
- **Resources**: 7.8GB/22GB RAM (34%), 78GB/193GB disk (41%) - Optimal
- **SSL**: Valid until January 2026 | **Uptime**: 99.9%+ | **Alerts**: 0 firing

### Recent Achievements (December 2025)
- âœ… **Forgejo Migration**: Infrastructure-as-code backup system operational
- âœ… **Cloud Platform**: Nextcloud + Notesnook production ready
- âœ… **Caddy Migration**: HTTP/3 QUIC, TLS 1.3, enhanced security
- âœ… **Unified Design System**: Complete visual identity across all services
- âœ… **CrowdSec Security**: Enterprise threat protection fully operational

---

## ðŸš€ Quick Start

### Essential Commands
```bash
# Complete setup from scratch
make secrets && make preflight && make up-all

# View system status
make ps && docker compose logs -f caddy

# Deploy themes across all services
./design-system/deploy-themes.sh verify

# Monitor backups and health
tail -f /var/log/securenexus-backup.log
```

### Service Management
```bash
# Staged deployment (recommended order)
make up-core          # Caddy, Tailscale, CrowdSec
make up-identity      # Authentik, PostgreSQL, Redis
make up-portal        # Landing, dashboard, branding
make up-monitoring    # Prometheus, Grafana, Loki
make up-dns           # CoreDNS, etcd, DNS updater

# Cloud services
docker compose --profile cloud up -d

# Individual service control
docker compose up -d [service]
docker compose restart [service]
docker compose logs -f [service]
```

---

## ðŸ—ï¸ Architecture Overview

### Core Infrastructure
SecureNexus Full Stack is a comprehensive self-hosted infrastructure providing identity management, monitoring, DNS, mail, and cloud services. Built on Docker Compose with **Caddy** as the central reverse proxy.

### Key Components
- **Caddy**: HTTP/3 QUIC reverse proxy, automatic SSL, security headers
- **Authentik**: SSO identity provider (v2025.10.1, PostgreSQL backend)
- **Forgejo**: Self-hosted Git forge (v9.0.3) with infrastructure backup
- **CrowdSec**: Real-time threat protection (100+ IPs blocked)
- **Tailscale**: VPN for secure admin access

### Service Profiles
- **core**: caddy, tailscale, crowdsec, souin_redis
- **identity**: authentik_db, redis_cache, authentik_server
- **portal**: landing, dashboard, branding
- **monitoring**: prometheus, grafana, loki, uptime-kuma
- **dns**: etcd, coredns, dns-updater, acme_webhook
- **mail**: mailcow (separate installation)
- **cloud**: nextcloud + notesnook (6 services)

### Security Model
- **Multi-layer Protection**: CrowdSec + Caddy security + VPN + SSO + Firewall
- **SSL/TLS**: Modern TLS 1.3, HTTP/3 QUIC, comprehensive security headers
- **Access Control**: Authentik OIDC for all services, Tailscale VPN for admin tools
- **Threat Detection**: Real-time IP filtering, CVE protection, automated blocking

---

## ðŸŒ Services & Access

Replace `securenexus.net` with your domain in all URLs.

### Main Services
- **Dashboard**: https://dashboard.securenexus.net (or https://dash.securenexus.net)
- **Git Forge**: https://git.yourdomain.com (Forgejo with SSO)
- **Status Monitor**: https://status.securenexus.net
- **Container Management**: https://portainer.securenexus.net

### Admin Services (VPN Required)
- **Grafana**: https://grafana.securenexus.net
- **Prometheus**: https://prometheus.securenexus.net

### Cloud Platform
- **Nextcloud**: https://nextcloud.securenexus.net (files, calendar, contacts)
- **Notesnook Sync**: https://notes.securenexus.net
- **Notesnook Auth**: https://identity.securenexus.net
- **Notesnook Events**: https://events.securenexus.net
- **Notesnook PDF**: https://mono.securenexus.net
- **Notesnook Files**: https://files.securenexus.net

### Service Health Checks
```bash
# Quick validation
make preflight && docker compose config --quiet
curl -I https://dashboard.securenexus.net

# Detailed health check
docker compose ps
docker stats --no-stream $(docker compose ps -q)
```

---

## âš™ï¸ Configuration & Setup

### Environment Configuration
**Required `.env` variables** (copy from `.env.example`):
- `DOMAIN`: Your primary domain (e.g., example.com)
- `EMAIL`: Admin email for ACME certificates

### Critical Secrets
Generated by `make secrets` - **never commit to version control**:
- `secrets/tailscale_authkey.txt` - VPN access (from Tailscale console)
- `secrets/authentik_secret_key` - 64 hex chars (**NEVER ROTATE** after deployment)

### Key Configuration Files

#### Essential Files
- `compose.yml` - Service definitions with profiles/networks/secrets
- `config/caddy/Caddyfile` - Reverse proxy, SSL, routing configuration
- `.env` - Domain and environment variables
- `secrets/` - Service credentials (auto-generated)

#### DNS & SSL
- `dns/Corefile` - CoreDNS configuration (etcd + file backends)
- `dns/zones/securenexus.net.zone` - DNS zone for static records
- `dns/mysql-init/` - MySQL schema for CoreDNS plugin

#### Design System
- `design-system/securenexus-unified.css` - Core design system (200+ CSS properties)
- `design-system/themes/` - Service-specific themes:
  - `authentik-theme.css`, `dashy-theme.css`, `mailcow-theme.css`
  - `portainer-theme.css`, `monitoring-theme.css`, `universal-theme.css`
- `design-system/deploy-themes.sh` - Automated deployment script

#### Monitoring & Scripts
- `monitoring/alert_rules.yml` - 30+ alert rules across 11 categories
- `monitoring/dashboards/` - Pre-configured Grafana dashboards
- `scripts/` - 30+ utility scripts (backup, setup, validation, maintenance)

### Secret Generation
`./scripts/generate-secrets.sh` supports modes: `hex:N`, `b64:N`, `plain:VALUE`, `empty`

---

## ðŸ”§ Operations & Maintenance

### Common Workflows

#### Adding New Service
1. Define in `compose.yml` with appropriate profile
2. Add Caddy config in `config/caddy/Caddyfile`
3. Generate any required secrets
4. Test: `docker compose up -d [service]`

#### Modifying Routes
1. Edit `config/caddy/Caddyfile`
2. Restart: `docker compose restart caddy`
3. Check: `docker compose logs -f caddy`

#### Theme Deployment
```bash
./design-system/deploy-themes.sh          # Deploy all themes
./design-system/deploy-themes.sh verify   # Verify deployment
```

### Troubleshooting

#### Quick Diagnostics
```bash
make preflight                            # Pre-deployment validation
docker compose config --quiet             # Syntax check
docker compose ps                          # Service health
docker compose logs -f [service]          # Real-time logs
curl -I https://[service].securenexus.net # Test endpoints
```

#### Service Issues
```bash
docker compose logs [service] | tail -20
docker stats --no-stream $(docker compose ps -q)
docker network inspect securenexus-fullstack_proxy
```

#### DNS & Connectivity
```bash
dig @localhost [domain]
docker exec [service] nslookup [target_service]
```

#### Cloud Services Debugging
```bash
# Notesnook MongoDB status
docker compose exec notesnook-db mongosh --eval "rs.status()"

# Nextcloud database backup
docker compose exec nextcloud-db pg_dump -U nextcloud > backup.sql

# Monitor cloud services
docker compose ps | grep -E "(nextcloud|notesnook)"
```

### Performance Monitoring

#### Key Metrics
- **Caddy**: Request rates, response times (<50ms), SSL expiration
- **DNS**: Query performance, CoreDNS health (ports 53/853/8080/9153)
- **VPN**: Tailscale connectivity for admin access
- **Cloud**: Nextcloud/Notesnook availability, MongoDB replica health
- **Security**: CrowdSec threat blocks, Mailcow queue status

#### Performance Features
- **HTTP Caching**: Souin (60s TTL, excludes auth/metrics)
- **Modern Protocols**: HTTP/3 QUIC, TLS 1.3, sub-50ms response
- **Resource Monitoring**: cAdvisor, disk space, PostgreSQL connections

---

## ðŸ’¾ Backup & Recovery

### Backup System Status âœ… Automated

#### Traditional Backups
- **Schedule**: Daily 2:00 AM (cron)
- **Size**: ~352MB
- **Location**: `/backup/securenexus/`
- **Retention**: 7 daily / 4 weekly / 12 monthly
- **Includes**: PostgreSQL, MongoDB, MySQL, etcd, Grafana, Prometheus, secrets, configs

#### Infrastructure-as-Code Backups
- **Schedule**: Daily 3:00 AM (cron)
- **Location**: https://git.yourdomain.com/yourusername/securenexus-infrastructure
- **Content**: 302 infrastructure files + 120+ documentation files
- **Benefits**: Version control, instant disaster recovery, no external dependencies

### Backup Management

#### Monitor Backups
```bash
tail -f /var/log/securenexus-backup.log    # Traditional backups
tail -f /var/log/forgejo-backup.log        # Infrastructure backups
ls -lh /backup/securenexus/{daily,weekly,monthly}/
```

#### Manual Operations
```bash
sudo ./scripts/backup-rotation.sh                    # Manual traditional backup
./scripts/forgejo-backup-automation.sh health        # Check Git backup health
./scripts/forgejo-stack-backup.sh backup            # Manual infrastructure backup
```

### Disaster Recovery

#### Quick Recovery Commands
```bash
# Database restoration
docker compose exec -T authentik_db psql -U authentik authentik < backup.sql
docker compose exec notesnook-db mongorestore --db notesnook /backup/path/

# Config restoration
cp -r /backup/securenexus/daily/*/config/* .

# Complete infrastructure recovery
git clone https://git.yourdomain.com/yourusername/securenexus-infrastructure.git
cd securenexus-infrastructure && make secrets && make up-all
```

See `docs/DISASTER_RECOVERY.md` for detailed procedures.

---

## ðŸ“š Reference & Resources

### Documentation (in `docs/`)

#### Status & Monitoring
- `CURRENT_STATUS.md` - Real-time system status
- `CLOUD_SERVICES_STATUS.md` - Nextcloud + Notesnook status
- `DESIGN_SYSTEM_DEPLOYMENT_COMPLETE.md` - Theme deployment status

#### Security & Operations
- `HARDENING_COMPLETE.md` - Security measures summary (A+ grade)
- `DISASTER_RECOVERY.md` - Recovery procedures (400+ lines)
- `ENHANCED_CADDY_DEPLOYMENT.md` - Caddy migration guide

#### Setup Guides
- `DNS_SETUP_GUIDE.md` - DNS configuration
- `VPN_SETUP.md` - Tailscale VPN setup
- `DESIGN_SYSTEM_GUIDE.md` - Theme implementation

### Utility Scripts (30+ in `scripts/`)

#### Essential Scripts
- **Setup**: `generate-secrets.sh`, `preflight.sh`, `smoke-postdeploy.sh`
- **DNS & SSL**: `dns-sync.sh`, `update-mailcow-certs.sh`
- **Identity**: `create-authentik-admin.sh`, `list-authentik-users.sh`
- **Backup**: `backup-rotation.sh`, `backup-all.sh`, `setup-automated-backups.sh`
- **Git Backup**: `forgejo-stack-backup.sh`, `forgejo-backup-automation.sh`
- **Maintenance**: `cleanup-docker.sh`, `setup-ufw-firewall.sh`

### Critical Configuration Notes

#### Service Dependencies
- **Start Order**: core â†’ identity â†’ others (cloud profile separate)
- **Network**: All services on `proxy` network, Caddy handles routing
- **DNS Strategy**: CoreDNS dual backend (file=static takes precedence, etcd=dynamic)

#### Security Requirements
- **Authentik Secret**: 64 hex chars, **NEVER ROTATE** after deployment
- **Tailscale Key**: Obtain from Tailscale console, one-time use
- **SSL**: ACME HTTP-01/DNS-01 challenge support
- **Health Checks**: Pragmatic strategy (some disabled for compatibility)

#### Service-Specific Notes
- **Mailcow**: Separate install in `mail/mailcow/`, sync certs via scripts
- **CrowdSec**: LAPI-only mode, patterns in `crowdsec/data/`
- **Monitoring**: Grafana VPN-only, Prometheus 2GB RAM allocation

### Quick Reference Commands
```bash
# Complete system setup
make secrets && make preflight && make up-all

# Health monitoring
docker compose ps && docker compose logs caddy
tail -f /var/log/securenexus-backup.log

# Theme management
./design-system/deploy-themes.sh verify

# Documentation access
ls docs/ && cat docs/CURRENT_STATUS.md
```

---

**Documentation Version**: 8.0 (Refactored & Reorganized) | **Last Updated**: December 29, 2025
**System Status**: âœ… **OPERATIONAL EXCELLENCE** (81 containers, A+ security/design)
**Infrastructure Backup**: https://git.yourdomain.com/yourusername/securenexus-infrastructure