# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SecureNexus Full Stack is a comprehensive self-hosted infrastructure stack providing identity management, monitoring, DNS, mail, and portal services. The system is built around Docker Compose with Traefik as the central reverse proxy handling SSL termination, routing, and security.

## Architecture

### Core Infrastructure
- **Traefik**: Central reverse proxy with automatic SSL via Let's Encrypt, middleware-based security
- **Authentik**: SSO identity provider with PostgreSQL backend and Redis cache
- **Docker Socket Proxy**: Secure Docker API access for Traefik
- **Tailscale**: VPN service for secure admin access to restricted services
- **CrowdSec**: Intrusion detection and prevention via Traefik bouncer

### Service Categories (Docker Compose Profiles)
Services are organized into Docker Compose profiles for staged deployment:
- `core`: Essential infrastructure (Traefik, Docker proxy, Tailscale, CrowdSec)
- `identity`: Authentication services (Authentik, PostgreSQL, Redis)
- `portal`: User-facing services (landing page, homepage portal, wellknown, branding)
- `monitoring`: Observability stack (Prometheus, Grafana, Loki, Promtail, exporters)
- `dns`: CoreDNS with etcd backend, MySQL plugin, dynamic DNS updater, ACME webhook
- `mail`: **Mailcow** (separate installation) - full mail server with SMTP, IMAP, webmail

**Note**: Most services are started explicitly via Makefile commands (not via `--profile` flags). See Makefile for exact service dependencies per deployment stage.

### Security Model
- Services protected by middleware chains: `admin-vpn` (Tailscale VPN only), `sso` (Authentik OIDC), `crowdsec-fa` (CrowdSec bouncer)
- Mail services handled by Mailcow (separate installation with own security policies)
- All secrets managed via Docker secrets from `./secrets/` directory
- SSL certificates automated via ACME HTTP-01 or DNS-01 challenge (DNS-01 uses etcd backend via ACME webhook)

## Development Commands

### Environment Setup
```bash
# Generate all required secrets
make secrets

# Validate configuration and environment
make preflight

# Validate Docker Compose configuration
docker compose config --quiet

# Check which services are defined for each profile
docker compose --profile core config --services
docker compose --profile identity config --services
docker compose --profile portal config --services
docker compose --profile monitoring config --services
docker compose --profile dns config --services
docker compose --profile mail config --services
```

### Service Management
```bash
# Start service groups incrementally
make up-core          # docker-proxy, traefik, souin_redis, tailscale, crowdsec, crowdsec_bouncer
make up-identity      # authentik_db, redis_cache, authentik_server, authentik_worker
make up-portal        # landing, homepage, wellknown, brand-static
make up-monitoring    # prometheus, blackbox, loki, promtail, grafana, cadvisor, node-exporter
make up-dns           # etcd, mysql-db, coredns, dns-updater, acme_webhook
# Note: Mail is handled by Mailcow (separate installation in mail/mailcow/)

# Start everything
make up-all

# Stop all services
make down

# View service status
make ps

# Follow logs for all services
make logs

# Restart specific service
make restart S=service_name
```

### Docker Compose Operations
```bash
# Direct Docker Compose usage
docker compose up -d [service...]
docker compose down
docker compose logs -f [service]
docker compose restart [service]

# Run a single service with dependencies
docker compose up -d --no-deps [service]

# Check service dependencies
docker compose config --services | sort

# Validate compose file syntax
docker compose config --quiet && echo "Configuration valid" || echo "Configuration error"

# View effective configuration for a service
docker compose config --services | xargs -I {} docker compose config --format json | jq '.services.{}'
```

### Verification
```bash
# Post-deployment smoke tests
./scripts/smoke-postdeploy.sh

# DNS record synchronization (manual trigger)
./scripts/dns-sync.sh
```

## Key Configuration Files

- `compose.yml`: Complete service definitions with profiles, networks, and secrets
- `config/traefik.yml`: Traefik static configuration
- `config/dynamic/traefik_dynamic.yml`: Middlewares, routes, and TLS configuration
- `config/dynamic/souin.yml`: HTTP cache configuration for Traefik
- `dns/Corefile`: CoreDNS configuration (etcd + file backends)
- `dns/zones/securenexus.net.zone`: DNS zone file for authoritative records
- `dns/mysql-init/`: MySQL schema initialization for CoreDNS mysql plugin
- `monitoring/`: Prometheus, Grafana, and alerting configurations
- `scripts/`: Utility scripts for setup, validation, and maintenance
- `secrets/`: All service credentials (generated by `make secrets`)
- `.env`: Domain and environment variables (copy from `.env.example`)

## Environment Configuration

Required `.env` variables (copy from `.env.example`):
- `DOMAIN`: Your primary domain (e.g., example.com)
- `EMAIL`: Admin email for ACME certificates
- `GRAFANA_OAUTH_SECRET`: Generate if using Grafana SSO

## Service Configuration Patterns

### Tailscale VPN
- Tailscale container runs in host network mode for VPN access
- Auth key stored in `secrets/tailscale_authkey.txt`
- Provides secure access to admin services (Grafana, Prometheus, Traefik dashboard)
- Configured via environment variables in compose.yml

### Mailcow Email Server
- Separate installation in `mail/mailcow/` directory
- Has its own docker-compose.yml and configuration
- Provides: SMTP, IMAP, POP3, webmail (SOGo), spam filtering (Rspamd)
- Ports: 25, 143, 465, 587, 993, 995, 4190

### Monitoring Stack
- `monitoring/dashboards/`: Pre-configured Grafana dashboards
  - `traefik-overview.json`: Proxy metrics and routing
  - `uptime-blackbox.json`: Service availability monitoring
- `monitoring/prometheus.yml`: Metrics collection configuration (includes CoreDNS scraping)
- `monitoring/promtail.yml`: Log shipping to Loki
- `monitoring/grafana/provisioning/`: Grafana datasources and dashboard provisioning

## Network Architecture

All services run on the `proxy` network with Traefik handling external traffic routing. Services communicate internally using service names as hostnames. External access is controlled through Traefik labels defining routing rules, middlewares, and security policies.

## Secret Management

Secrets are stored in `./secrets/` as individual files and mounted into containers via Docker secrets. Never commit secrets to version control. Use `make secrets` to generate all required credentials.

### Secret Management Guidelines
- Never commit files in `secrets/` directory
- Authentik secret key must remain constant (breaks sessions if changed)
- Use strong passwords: `openssl rand -base64 32`
- Rotate non-critical secrets periodically

## Middleware Security Layers

- `admin-vpn@file`: Restricts access to Tailscale VPN network IPs
- `sso@file`: Requires Authentik OIDC authentication
- `crowdsec-fa@file`: CrowdSec fail2ban protection
- `secure-headers@file`: Security headers (HSTS, CSP, etc.)

### Network Isolation Security
- Admin services use `admin-vpn` middleware (Tailscale VPN only)
- Mail security handled by Mailcow's built-in policies and firewall rules
- CrowdSec provides intrusion detection via `crowdsec-fa` middleware

## DNS and SSL Integration

CoreDNS provides authoritative DNS with dual backend support:
- **etcd backend**: Dynamic records created by `dns-updater` service watching Docker events
- **file backend**: Static zone records from `dns/zones/securenexus.net.zone`

SSL certificates via ACME:
- **HTTP-01 challenge**: Default method (requires external DNS propagation)
- **DNS-01 challenge**: Via `acme_webhook` service updating etcd TXT records

The `dns-updater` service automatically creates A records for Traefik-managed containers with appropriate labels.

## Testing & Validation

### Pre-deployment Validation
```bash
# Run comprehensive preflight checks
make preflight

# Validate Docker Compose syntax
docker compose config --quiet

# Check required secrets exist
for secret in $(docker compose config | grep -oP 'secrets/\K[^:]+' | sort -u); do
  [ -f "secrets/$secret" ] && echo "✓ $secret" || echo "✗ $secret missing"
done
```

### Service Testing
```bash
# Test individual service deployment
docker compose up -d [service] && docker compose logs [service] | tail -20

# Health check status for all services
docker compose ps --format json | jq -r '.[] | "\(.Service): \(.Health)"'

# Test service connectivity
docker compose exec [service] ping -c 1 [target_service]
```

## Troubleshooting Commands

```bash
# Check service health and dependencies
docker compose ps
docker compose logs [service_name]

# Validate configuration before deployment
make preflight

# Monitor specific service logs in real-time
docker compose logs -f [service_name]

# Check Traefik routing and middleware status
curl -H "Host: traefik.${DOMAIN}" http://localhost/api/rawdata

# Test DNS resolution
dig @localhost [domain]

# Verify secret generation
ls -la secrets/

# Debug service networking
docker compose exec [service] nslookup [target_service]
docker network inspect securenexus-fullstack_proxy

# Check service resource usage
docker stats --no-stream $(docker compose ps -q)
```

## Common Development Workflows

### Adding a New Service
1. Define service in `compose.yml` with appropriate profile
2. Add Traefik labels for routing and middleware
3. Generate secrets if needed: `echo "secret_value" > secrets/new_secret.txt`
4. Test with: `docker compose up -d new_service`

### Modifying Traefik Routes
1. Edit `config/dynamic/traefik_dynamic.yml`
2. Traefik auto-reloads dynamic config (no restart needed)
3. Verify with: `curl -H "Host: traefik.${DOMAIN}" http://localhost/api/rawdata`

### Debugging Service Connectivity
1. Check service logs: `docker compose logs -f service_name`
2. Verify network membership: `docker network inspect securenexus-fullstack_proxy`
3. Test internal DNS: `docker exec service_name nslookup other_service`

## Monitoring Access

### Default Service URLs (replace example.com with your domain)
- Grafana: `https://grafana.example.com` (VPN-only access via Tailscale)
- Prometheus: `https://prometheus.example.com` (VPN-only access via Tailscale)
- Traefik Dashboard: `https://traefik.example.com` (VPN-only access via Tailscale)
- Uptime Kuma: `https://status.example.com` (public with CrowdSec protection)
- Homepage Portal: `https://portal.example.com` (public)
- Mailcow Webmail: Configured separately in Mailcow installation

### Key Metrics to Monitor
- Traefik request rates and response times
- DNS query performance and resolution success
- Certificate expiration dates
- Tailscale VPN connectivity
- Mailcow mail queue and delivery status

## Performance Tuning

### HTTP Caching (Souin)
- Configuration: `config/dynamic/souin.yml`
- Caches responses based on TTL headers
- Automatic cache invalidation

### Resource Monitoring
- Use cAdvisor for container resource usage
- Monitor disk space for log volumes
- Watch PostgreSQL connection counts

## Important Notes

- **VPN Service**: Project uses Tailscale for secure admin access to monitoring and management interfaces
- **Mail Server**: Mailcow installed separately in `mail/mailcow/` directory with its own docker-compose stack
- **Service Dependencies**: Start services in profile order (core → identity → others) for proper initialization
- **Secret Rotation**: Authentik secret key (64 hex chars) should not be rotated post-installation
- **Cache Layer**: Souin provides HTTP caching through Traefik for improved performance

## Secret Generation Patterns

The `./scripts/generate-secrets.sh` script supports multiple generation modes:
- `hex:N` - N bytes as hexadecimal (e.g., API keys)
- `b64:N` - N bytes as base64 (e.g., passwords)
- `plain:VALUE` - Write literal value (e.g., usernames)
- `empty` - Create empty file (e.g., for manual auth keys)

## Service Health Monitoring

All critical services include Docker health checks:
- **Automatic recovery**: Docker restarts unhealthy containers
- **Dependency awareness**: Use `docker compose ps` to check service status
- **Monitoring integration**: Health status exposed to Prometheus

## Stack-Specific Notes

### Traefik Configuration
- **Static config**: `config/traefik.yml` (requires restart)
- **Dynamic config**: `config/dynamic/traefik_dynamic.yml` (auto-reloads)
- **Plugin system**: Souin cache and rewritebody plugins enabled
- **⚠️ IMPORTANT - ACME email**: Currently hardcoded to admin@securenexus.net in `config/traefik.yml:49` - MUST be updated to your email address before deployment

### DNS Architecture Notes
- **CoreDNS** runs on ports 53 (TCP/UDP), 853 (DNS-over-TLS), 8080 (health), 9153 (metrics)
- **etcd** stores dynamic DNS records at path `/coredns`
- **MySQL** backend available for mysql plugin (optional, not currently active)
- **Zone file + etcd**: Both active simultaneously (file provides NS/SOA, etcd provides dynamic A records)
- **ACME webhook**: Python Flask app updates etcd for DNS-01 ACME challenges

### Caching Strategy
- Souin excludes real-time endpoints (ACME, OIDC, metrics, APIs)
- 60s TTL with 30s stale serving for performance
- Regex-based exclusion patterns prevent auth/security bypasses

## Backup & Recovery

### Critical Data to Backup
```bash
# PostgreSQL databases (Authentik user data)
docker compose exec authentik_db pg_dump -U authentik authentik > backup_authentik_$(date +%Y%m%d).sql

# etcd data (dynamic DNS records)
docker compose exec etcd etcdctl snapshot save /tmp/etcd_backup.db
docker compose cp etcd:/tmp/etcd_backup.db backup_etcd_$(date +%Y%m%d).db

# MySQL database (CoreDNS mysql plugin backend, if used)
docker compose exec mysql-db mysqldump -u coredns -p$(cat secrets/mysql_password) coredns > backup_mysql_$(date +%Y%m%d).sql

# Grafana dashboards and settings
docker compose exec grafana tar -czf - /var/lib/grafana > backup_grafana_$(date +%Y%m%d).tar.gz

# Tailscale VPN state (if needed)
docker run --rm -v securenexus-fullstack_tailscale-data:/data -v $(pwd):/backup alpine tar -czf /backup/backup_tailscale_$(date +%Y%m%d).tar.gz -C /data .

# DNS zone files
tar -czf backup_dns_zones_$(date +%Y%m%d).tar.gz dns/zones/

# ACME certificates (Let's Encrypt)
tar -czf backup_acme_$(date +%Y%m%d).tar.gz acme/

# All secrets (IMPORTANT: Store securely!)
tar -czf backup_secrets_$(date +%Y%m%d).tar.gz secrets/
```

### Automated Backup Script
```bash
#!/bin/bash
# Create comprehensive backup
BACKUP_DIR="/backup/securenexus-$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# Export databases
docker compose exec -T authentik_db pg_dump -U authentik authentik > "$BACKUP_DIR/authentik.sql"
docker compose exec -T mysql-db mysqldump -u coredns -p$(cat secrets/mysql_password) coredns > "$BACKUP_DIR/mysql.sql" 2>/dev/null || true

# Export etcd
docker compose exec etcd etcdctl snapshot save /tmp/etcd_backup.db
docker compose cp etcd:/tmp/etcd_backup.db "$BACKUP_DIR/etcd.db"

# Export volumes
docker run --rm -v securenexus-fullstack_grafana-data:/data -v "$BACKUP_DIR":/backup alpine tar -czf /backup/grafana.tar.gz -C /data .
docker run --rm -v securenexus-fullstack_tailscale-data:/data -v "$BACKUP_DIR":/backup alpine tar -czf /backup/tailscale.tar.gz -C /data .

# Copy configuration
cp -r secrets/ config/ dns/zones/ "$BACKUP_DIR/"

echo "Backup completed: $BACKUP_DIR"
```

### Recovery Procedures
```bash
# Restore PostgreSQL (Authentik)
docker compose exec -T authentik_db psql -U authentik authentik < backup_authentik.sql

# Restore etcd
docker compose cp backup_etcd.db etcd:/tmp/etcd_backup.db
docker compose exec etcd etcdctl snapshot restore /tmp/etcd_backup.db

# Restore MySQL (if used)
docker compose exec -T mysql-db mysql -u coredns -p$(cat secrets/mysql_password) coredns < backup_mysql.sql

# Restore Grafana data
docker run --rm -v securenexus-fullstack_grafana-data:/data -v $(pwd):/backup alpine tar -xzf /backup/grafana.tar.gz -C /data

# Restore Tailscale data (if needed)
docker run --rm -v securenexus-fullstack_tailscale-data:/data -v $(pwd):/backup alpine tar -xzf /backup/tailscale.tar.gz -C /data

# Restore secrets and configuration
tar -xzf backup_secrets.tar.gz
tar -xzf backup_dns_zones.tar.gz
```

### Backup Schedule Recommendations
- **Daily**: Database dumps (automated via cron)
- **Weekly**: Full configuration backup including secrets
- **Before updates**: Complete system state backup
- **Store backups**: Off-site (encrypted) for disaster recovery

## Known Issues and Migration Notes

### PowerDNS → CoreDNS Migration
The system has been migrated from PowerDNS to CoreDNS with etcd backend:
- **Previous**: PowerDNS with MySQL backend and pdns-admin interface
- **Current**: CoreDNS with dual backend (etcd for dynamic records + zone files for static records)
- **Impact**: Some legacy PowerDNS configuration files remain in `dns/` directory but are no longer active

### CoreDNS Dual Backend Configuration
CoreDNS is configured with **both** etcd and file backends simultaneously:
- **File plugin**: Loads `dns/zones/securenexus.net.zone` for NS, SOA, and static A records
- **etcd plugin**: Provides dynamic A records created by `dns-updater` service
- **Important**: Overlapping records may cause conflicts - file plugin takes precedence

### Dynamic DNS Updates
The `dns-updater` service automatically watches Docker events and creates/deletes DNS records in etcd:
- Monitors container start/stop events
- Creates A records for containers with Traefik labels
- Updates etcd at path `/coredns`
- Runs every 30 seconds

### ACME Certificate Challenge Options
Two methods available for SSL certificate generation:
1. **HTTP-01 challenge** (default):
   - Requires domain to be publicly resolvable
   - Traefik handles challenge automatically
   - Check `config/traefik.yml` for ACME configuration

2. **DNS-01 challenge** (via acme_webhook):
   - Python Flask service updates etcd TXT records
   - Allows wildcard certificates
   - Does not require port 80/443 to be publicly accessible
   - Webhook URL: `http://acme_webhook:5000/update-txt-record`

### CrowdSec Status
CrowdSec services ARE defined in `compose.yml` (lines 146-174):
- `crowdsec`: Main intrusion detection service
- `crowdsec_bouncer`: Traefik bouncer for blocking malicious IPs
- Both are in `core` profile
- Middleware `crowdsec-fa@file` references these services
- To enable: `make up-core` (or `docker compose up -d crowdsec crowdsec_bouncer`)

### Common Configuration Pitfalls

1. **Zone file + etcd conflicts**:
   - If same record exists in both, file plugin wins
   - Recommendation: Use zone file only for NS/SOA, let etcd handle A records

2. **Internal vs external DNS**:
   - CoreDNS listens on port 53 for authoritative queries
   - Services use Docker's internal DNS (127.0.0.11) for container resolution
   - Some services need explicit DNS servers (see compose.yml:76-78 for Traefik example)

3. **Hardcoded credentials in compose.yml**:
   - Lines 220-222, 249-251: Authentik credentials are hardcoded in environment variables
   - Should use Docker secrets instead (secrets are defined but not referenced)

4. **ACME email configuration**:
   - Currently passed via command line in compose.yml:74
   - Also exists in config/traefik.yml:49 (may be hardcoded to admin@securenexus.net)
   - Ensure both match your actual email

### Legacy Files in dns/ Directory
Some PowerDNS configuration files remain but are not used:
- `dns/pdns.conf`, `dns/pdns-mysql.conf` - PowerDNS server config (obsolete)
- `dns/pdns-admin.env` - PowerDNS admin interface config (obsolete)
- `dns/Dockerfile.pdns-admin` - Custom Dockerfile for pdns-admin (obsolete)
- `dns/securenexus.net.zone` - May be the active zone file (verify vs `dns/zones/`)

Safe to remove once confirmed CoreDNS is fully operational.
- add to memory
- save results of diagnosis