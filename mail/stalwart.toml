# Stalwart Mail Server Configuration
# Submission-only SMTP configuration for SecureNexus

[server]
hostname = "mail.securenexus.net"

[server.listener."smtp"]
bind = ["0.0.0.0:25"]
protocol = "smtp"
tls.implicit = false

[server.listener."smtp-submission"]
bind = ["0.0.0.0:587"]
protocol = "smtp"
tls.implicit = false

[server.listener."smtps"]
bind = ["0.0.0.0:465"]
protocol = "smtp"
tls.implicit = true

[server.listener."management"]
bind = ["0.0.0.0:8080"]
protocol = "http"

[server.tls."smtp"]
enable = true
implicit = false
certificate = "default"

[server.tls."smtp-submission"]
enable = true
implicit = false
certificate = "default"

[server.tls."smtps"]
enable = true
implicit = true
certificate = "default"

[certificate."default"]
cert = "/etc/ssl/certs/server.crt"
private-key = "/etc/ssl/private/server.key"

[session.auth]
mechanisms = ["plain", "login"]
directory = "internal"

[session.auth.errors]
total = 3
wait = "5s"

[session.extensions]
pipelining = true
chunking = true
requiretls = true
no-soliciting = ""

[session.data]
max-messages = 10
max-message-size = 25000000

[session.data.limits]
size = 25000000
messages = 100

[session.rcpt]
relay = true
directory = "internal"
max-recipients = 100

[session.rcpt.errors]
total = 5
wait = "5s"

[session.mail]
rewrite = [ { if = "listener", eq = "smtp-submission", then = "header.set.Return-Path" },]

[authentication]
fallback-admin.user = "admin"
fallback-admin.secret = "$6$YshAUR7GPB/4yzin$oFO4S2PAX0ZWoqi/gytgWlaghOdYjg67VoGb.B3jn5EMdAAPvaD9c03fbw38ei1B4oeiFBZXdjJo9qO7ML4YF."

[directory."internal"]
type = "internal"
store = "data"

[store."data"]
type = "sqlite"
path = "/var/lib/stalwart-mail/data.db"

[tracer]
type = "console"
level = "info"

# Rate limiting
[session.throttle]
auth = [{if = "listener", eq = "smtp-submission", then = "100/1h"}]
rcpt = [{if = "listener", eq = "smtp-submission", then = "50/1h"}]
mail = [{if = "listener", eq = "smtp-submission", then = "25/1h"}]

# Relay configuration for submission
[session.auth.directory]
name = "internal"

[queue]
path = "/tmp/queue"
hash = 64

[queue.outbound]
next-hop = [
  {if = "rcpt-domain", in-list = "local-domains", then = "local"},
  {if = "authenticated-as", ne = "", then = "[smtp]:25"},
  {else = false}
]
hostname = "mail.securenexus.net"

[list."local-domains"]
entries = ["securenexus.net"]

[report]
path = "/tmp/reports"

# Enable IMAP for mail access
[server.listener."imap"]
bind = ["0.0.0.0:143"]
protocol = "imap"
tls.implicit = false

[server.listener."imaps"]
bind = ["0.0.0.0:993"]
protocol = "imap"
tls.implicit = true

[server.tls."imap"]
enable = true
implicit = false
certificate = "default"

[server.tls."imaps"]
enable = true
implicit = true
certificate = "default"

# Disable services we don't need
[server.listener."pop3"]
enable = false

[server.listener."managesieve"]
enable = false